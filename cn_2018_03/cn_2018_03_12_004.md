 
 博士(tl,看到我的视频演示/本文的演示)) 
  
  
 维护服务器分为两个阶段: 
  
  
 最近,我一直在尝试让第一阶段更接近第二阶段。因为没有更好的词,我称之为文字devops。 
  
  
我已经讨论过使用org-mode的文字编程模型研究新思想以及结晶思想，这种方法似乎很适合我，因为我缺乏那些深奥的系统管理员技能。
  
  
 从前,我是负责修补一个RPM,不在我的擅长领域,所以我最初的进攻计划是: 
  
  
 当然,一旦我找到解决方案,需要团队中的其他人记录它,或创建一个可重复的脚本。 
  
  
 第一步是有据可查的,但是今天我学到了(TIL) 你可以直接使用ssh Vagrant-based虚拟机 ，这个小魔术(注:客户端是我在Vagrantfile中指定的虚拟机的名称): 
  
  
 这个命令附加了一些可爱的主机连接魔法，所以您可以发布:ssh clientvm。 
  
 
 我没有向我的虚拟机打开一个终端，而是插入Emacs并加载这个sprint的note file1，创建一个新的头，并在这个文本文件中输入shell和ruby命令 
  
  
 这是什么好东西?与传统的终端不同，这允许我日志、记录和执行每个命令 。
  
  
 例如,这是我Emacs缓冲区的一个部分的截图: 
  
  
作为一个头脑非常小的老熊，我的散文可以解释每个命令的背景和目的。点击这个超级链接可以刷新我对以前发现的记忆。keychord执行代码块…
  
  
 是的。我在Emacs中执行命令。 
  
 
 使用C-c C-c (Control-C两次)运行代码(基于语言)。这个例子在shell中运行。结果被放回文件中，可以由其他代码块(以及其他选项)使用。 
  
 
 例如，这里是从存储库下载GPG密钥的一节的前半部分(URL位于其部分所有代码块共享的属性中): 
  
  
 Shell脚本块(在屏幕快照的中心)使用wget下载HTML索引文件，并解析和提取密钥文件url。我们将使用一个Ruby脚本进行解析，而且由于脚本可能有点麻烦，我们将在另一个代码块中定义它。 
  

 读写编程的一种技术是，可以将一个代码块插入到另一个块中(引用是双尖括号中的名称，<<…>>)。Donald Knuth称此功能为WEB。因为它会不小心与某些语言发生冲突。(和Ruby一样)，默认情况下是关闭的，但是现在用noweb参数打开它。
  
  
 这是Ruby脚本。把它放在一个单独的Ruby代码块中，可以让我打开Emacs所能收集到的所有Ruby魔法。 
  
  
  
 最后一步是获取第一个脚本生成的url，并将它们提供给另一个Shell脚本，该脚本将调用wget来下载它们:
  
  
 密钥表是我们原始代码块的名称,以及 其结果的名称。。我们将结果列表分配给一个变量，shell脚本将以$ list的形式访问列表。
  
  
 这个例子演示了文字编程如何通过不同的语言编织代码和数据。 
  
 
 通常，指定sh作为代码块的语言，告诉Emacs在本地系统的shell中运行代码，但是在这种情况下，我希望它在我的虚拟机(或者我的实验室的开发服务器）上运行。这样做，我将使用Tramp和Babel会话来描述这样做的两个选项。
  
 
 Tramp是一种Emacs特性，它允许使用ssh和其他协议在远程机器上编辑文件。例如，运行find-file函数(绑定到C-x C-f)可以让您输入以下内容:
  
  
如果您在.emacs初始化文件中添加以下内容:


更新~ /。ssh/config文件了解用户帐户与主机名的关系，上面的文件引用可以缩短为:


Emacs查找:字符以确定是否应该调用Tramp。Tramp使用SSH密钥，如果需要，将提示您输入密码。


每个org-mode代码块都可以指定一个:dir选项，该选项指定代码片段应该在哪里运行，例如，以下块是等效的:

 
 dir选项允许完整的Tramp功能，允许我在另一台机器上运行一个块。记得我是如何将我的客户端虚拟机添加到我的~/.ssh /config file
  
  
 但是我需要在防火墙后面访问我的机器!


我的工作是处理在一个高度保护的数据中心运行的虚拟机，在那里我需要先登录到跳转框和bastion机器。不定期负责处理这些啤酒花。例如: 
  
  
使用我的帐户名登录到bastion机器，然后使用我的帐户名ssh到运行在私有云中的虚拟机。然后使用sudo命令，让我编辑root拥有的文件。


Tramp管道引用使用:dir选项用于组织模式来源：
  
  

 记住一些技巧: 
  
   
另一种方法是创建一个会话，将不同的代码块连接在一起。下面的每个屏幕截图，每个代码块都有相同的会话值，客户端(这与我的虚拟机的主机名相同，客户机):


如果我执行第一个块，就会在后台启动一个shell，并且它会ssh到机器中。请注意，要实现此工作，您需要通过将SSH的公共密钥放入远程系统的.ssh/authorized_keys文件或使用SSH Emacs包来启用无密码访问。


从这一点开始，我使用客户机会话值执行每个代码块，使用此连接，并在远程机器上执行代码(在本例中为虚拟机，但这并不重要)。
  
  

 这两种方法都很有效，但第二种方法允许我设置变量来创建其他块可能期望的特定状态。但是，这需要依次执行每个块。 
  
  

我有第三个，更互动的，使用屏幕的方法，但它不允许将变量传递给代码，正如你将看到的，这对我来说非常重要。


无论如何，我继续学习如何实现我的目标，所有的过程都是记录和验证我的步骤。最终结果可以导出到web或wiki页面。

  
是的，执行一些命令可能非常耗时和冗长，但通常我需要搜索结果，并将结果放在Emacs缓冲区中，这样可以更好地搜索。


我经常使用一个可折叠的“抽屉”(它只是识别输出的开始和结束的一种方式):


将光标放在这个抽屉上，按Tab键隐藏或显示输出:


下一个命令通常需要一些命令的结果，我相信您喜欢用鼠标复制和粘贴部分输出，但是我有一个更好的方法。


例如，我需要一个RPM的依赖关系列表:

  

 注意，我命名了这个源代码块。还要注意Emacs是如何自动将结果分解成表的。默认情况下，shell命令的输出将沿着新行和空格分开。


我可以将这些执行的结果传递给另一个代码块。下面的源块创建一个名为DEPENDS的变量，它使用第一个列中的第2行到第10行作为数组。

然后，我下载了我想要的rpm，没有任何鼠标交互。

重用的一个关键方面devops项目(如厨师食谱)是分离的代码值代码使用…你重用任何程序的一个关键方面。


在我的世界中，我为每个sprint创建一个新的org-mode文件，每个任务或问题都有自己的header和section。每个部分都可以有一个属性的抽屉，包括该部分中所有代码块共享的变量。


要创建一个section变量，只需点击:C-c C-x p，并将属性设置为var，并将值设置为变量=值，如:


这个抽屉可以包含您希望的任何代码块值，比如会话或结果。这些值可以被重写为代码块的设置，正如您在屏幕截图中看到的:


设置变量和设置(特别是会话设置)，将代码块绑定在一起。


虽然在操作和管理方面的调查(如我所描述的)在理解问题领域时对自己有用，但是我需要与我的团队伙伴交流结果。由于我的Emacs配置允许我发送邮件消息，所以我启动了这个函数，org-mime-org-buffer-htmlize，它将org-mode文件导出到一个HTML邮件消息(该函数是最新的org-plus- b包的一部分)。


然而，有时导出的结果并不十分完美。


例如，一些块可能会影响一些JSON数据，由于HTML输出可以对语法进行着色，如果我可以指定输出结果是JavaScript，那么JSON数据就会更漂亮。只需使用wrap参数，如:


在我的org模式文件中，如下所示:


获得出口:


另一个例子是，我当前的项目涉及到OpenStack，它的nova命令行实用程序试图将数据格式化为一个表:


如果您手动更改输出，那么当导出文件时，这些更改将不会被授予(因为在导出过程中重新执行了这些更改)。 
  
  
这样做的方法是使用一些Emacs Lisp代码块，您只需要将其放置在文件的某个地方，比如:


使用这个名为“nova-conv”的代码块，我可以将其用于后处理结果，如:


在我的特殊情况下，我还想去掉第一行的破折号以使它更像组织模式:


要真正的可重用，将此代码放置在Babel的库中，然后从任何文件中都可以获得该代码。


虽然我的读写devops方法不应该取代实际的devops (OpsDev?)自动化，但我发现这个方法很有用，原因有两个:


关于最后一点，我经常在写和执行代码之前，用过去时态写我的文字文件，比如:


然后,如果我下面的命令或过程失败,我可以高亮的部分文档,点击c-x M电子邮件一个HTML版本出口到团队的其他成员(否则,我会花几个小时复制/粘贴从终端,以提供足够的上下文的邮件)。


需要一个完整的示例吗?看看我的笔记设置IP表(原始org-mode文件),文件的部分可以在编辑器中执行为了查看我的机器配置,另一部分是一个脚本,该脚本可以混乱机器和执行重置防火墙规则。


感谢你的阅读。


对于每一个新的sprint，我创建一个org-mode格式的文件来跟踪任务、注释和其他细节。这使得它很适合嵌入一些有文字的devops。


每个操作系统在不同的目录位置创建临时文件。大多数Unix系统使用/tmp/，但mac使用/var/ folders/。当前的组织模式代码在远程系统上使用相同的目录名，这将在本地系统上工作。在我的例子中，我在工作中使用我的Mac笔记本电脑连接到我的数据中心的一个Linux系统，我得到了以下错误:


错误在org-mode版本8.2.10(可能更早)，正如我在这个邮件列表中发现的(它可能在一段时间内不会被修复，因为现在还不清楚最好的解决方案是什么)。要自己修复它，编辑obcore.el在org-babel- tempfile函数中的文件为:

  
 如果安装ssh.el项目，您最初将使用:M-x ssh连接到您的远程系统。


然后，您将输入主机连接信息，包括密码(如果需要)，等等。例如，如果我连接到主机：goblin.howardism.org,然后我的代码块会引用这样一个session：


这允许您监视您的代码在远程系统上执行，但是仍然允许一个功能完整的代码块，它可以从org-mode文件的其他部分读取值。


注意:会话参数的值由*字符(缓冲区名称的一部分)包围，但是要传入的变量被引号包围(否则，它们被解释为文档中其他地方的表的命名引用)。


我有第三种执行远程命令的方法，这使用了obs -screen扩展(位于org-mode的设计集合中)。它使用了Gnu屏幕和xterm，所以在我的Mac上，我启动了XQuartz(内置的X Windows模拟器)，并将下面的内容添加到我的.emacs初始化(基于这些指令)来设置我的xterm程序的完整路径:


我不经常使用screen，但我使用自制程序来安装:


然后告诉ob-screen如何找到它:


代码块现在被指定为screen，我通常指定使用哪个xterm窗口来设置:会话参数:


结果不会被放到Emacs文件缓冲区中，但就像在xterm窗口中一样。

使用screen的另一个缺点是它不传递变量。例如，以下方法不起作用:


看到xterm窗口中来回的结果很好，但有限的是不能将结果返回到文件中进行进一步处理。此外，您必须抵制在xterm窗口中输入命令的诱惑。如果您沿着这条路径走下去，您可能会忘记将这些信息返回到您的org-mode文件中，以后可能会后悔。
  
  
   
  URL : http://howardism.org/Technical/Emacs/literate-devops.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website
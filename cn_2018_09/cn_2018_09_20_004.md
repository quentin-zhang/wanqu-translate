# Shopify的移动顶帽
Shopify是一家领先的基于云的多渠道商业平台，面向超过175个国家的60多万家商家，关键是测试和验证引入新功能的平台。因为公司没有一个QA设计团队、测试特性是开发人员的责任。为此,我们建立了一个项目，以包含通过持续集成基础结构(continuous integration infrastructure, CI)执行的自动化测试步骤，额外的手动检查由开发人员执行。
其中一个手动检查之前尝试更改合并到代码库。我们称这一过程“tophatting”🎩emoji.在Github不支持代码审查请求的时候，Shopify依靠表情符号来轻松地传达代码审查过程的状态。🎩表明审查员不仅看了代码,还跑在本地以确保一切是expected,尤其是interface的变化影响用户
顶环过程中,需要开发人员保存他们目前的工作,检验不同的git分支,建立当地环境和构建移动开发者的应用。这个过程往往是乏味的,因为改变git分支缓存无效,增加在Xcode中构建时间和Android工作室。根据项目的不同，它需要15分钟来构建应用程序，在此期间，开发人员不能在同一项目中做任何其他工作。
为了消除他们的痛点并促进最佳实践，我们创建了一个快速、无摩擦的tophatting过程，它无缝集成了我们的CI基础设施和dev, Shopify的通用开发工具，所有的移动开发者都在他们的环境中运行。在这篇文章中，我将描述我们如何构建无摩擦顶帽过程，并向您展示它是什么样子的一个例子。
为Tophat建立项目
 移动顶帽过程中最慢的部分是编译。为了加快移动开发者的速度，我们跳过了编译步骤。我们已经在CI上构建了应用程序，因此应用程序二进制文件可以在我们为运行PR构建而创建的一次性环境中使用。我们更新了项目管道以导出二进制文件，以便通过CI API列出并访问它们。根据平台(iOS或Android)的不同，导出的应用程序有不同的格式:
 iOS:应用程序是文件夹，我们使用命名约定来压缩文件夹，其中包括应用程序的名称和版本。例如，导出的Shopify应用程序版本3.2.1将命名为Shopify-3.2.1.app.zip。
 Android:APK文件是zip归档文件，所以我们用它的现有名称导出它们。
 一旦应用程序被导出，我们利用GitHub提交状态让开发者知道他们的PRs有tophattable构建:
命令行接口
 Dev是一个内部工具，它为公司的所有项目提供了一组标准命令(您可以在devproductivity.io上阅读有关它的更多信息)。后端开发人员使用的命令之一是tophat，我们将其扩展到支持移动项目
  命令的样子: 
    平台可以是ios或android，资源可以是以下任何一种:
    拉请求URL:用于顶帽其他开发人员的工作
    存储库URL:用于顶置存储库的主分支
    存储库分支URL:用于顶置特定的
    分支构建URL:用于从CI创建特定的构建
 例如，如果开发人员想将project android的pull request 35放到顶部，他们可以运行以下命令:
    dev android tophat https://github.com/shopify/android/pulls/35
 引擎盖下
 运行tophat命令时,执行以下步骤: 
  1.如果还没有对Buildkite和GitHub API进行身份验证，则对用户进行身份验证。访问令牌持久化在macOS密钥链中，以便在将来的API调用中重用。
  2.如果给定的资源是GitHub URL，我们使用commit状态来获取构建的URL。
  3.由于工件列表可能包含不能通过tophatting完成的资源，所以我们过滤掉它们，只显示有效的资源。如果库中有多个应用程序，开发人员可以选择他们想要使用的应用程序。
  4.选择app后:
    1.对于iOS项目，我们列出系统模拟器，并引导到用户选择的那个。大多数情况下，开发人员倾向于使用相同的模拟器，这样命令就会记住并将其建议为默认
    2.对于Android项目，我们列出了环境中可用的模拟器和一些默认模拟器，以防开发人员还没有在本地配置任何模拟器。
  5.一旦模拟器启动，我们安装应用程序并启动它。
  下面的例子展示了在iOS平台上建立Shopify Mobile平台的过程:
  未来的改进
  我们对我们的移动开发者的反应感到兴奋;他们喜欢这个功能。自从我们发布以来，Shopifolks热情地提交了bug报告和建议，并提出了许多关于如何持续改进tophatting过程的想法。我们目前正在进行的一些改进包括:
  缓存:每次启动tophat进程时，我们都会从Buildkite中提取工件，即使我们已经完成了构建。添加本地缓存将防止再次下载工件，并将其复制到缓存中。   真正的设备:开发人员通常在真正的设备上尝试应用程序，我们想促进这一点。对于iOS，构建需要使用一个允许在测试设备上安装应用程序的有效证书进行签名。
  来自commit和branch的Tophat:与其传递整个GitHub URL，不如让开发人员指定他们想要的存储库和branch/commit来简化输入。
  测试别人的工作现在比以往更容易。我们的开发人员不需要知道如何设置环境或编译应用程序。它们可以运行一个命令，其余的由工具来完成。移动工具团队致力于收集反馈，并与我们的移动开发人员合作，添加改进和bug修复，以促进他们的工作流程。
  URL : https://engineering.shopify.com/blogs/engineering/mobile-tophatting-at-shopify-1?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website
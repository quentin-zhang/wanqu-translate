随着越来越多的人在世界各地连接在Facebook上,我们要确保我们的应用程序和服务在各种场景中工作得很好。在Facebook的规模,这意味着测试数以百计的重要交互跨许多类型的设备和操作系统的正确性和速度在我们船新代码。 
 去年,我们介绍了Facebook移动设备的实验室,可以让工程师运行测试通过访问数以千计的移动设备在我们的数据中心。从那时起,我们已经建立了一个新的、统一的资源管理系统,代号为同一个世界,举办这些设备和其他运行时,如web浏览器和模拟器。Facebook的工程师可以使用单个API与这些在他们的测试和其他自动化系统远程资源。一个世界增长管理成千上万的资源,用于执行每天超过100万个工作岗位。在这个规模,我们学到了很多,当我们遇到独特挑战建立一个系统,可以处理设备可靠性的复杂性而暴露一个易于使用的API。 
 在一个世界里,我们的目标是支持任何应用程序,一个工程师可能需要使用远程运行时和最小的修改他们的代码或环境。这意味着支持标准通信机制(如亚洲开发银行(Android调试桥)和提供远程设备连接本地的错觉。我们的系统包含四个主要组件: 
  
 每个资源驻留在一个世界一个工人服务具有以下职责: 
 在职工服务,这些步骤表示为一个状态机。每个州都有监控和日志我们可以了解系统中的瓶颈,失败率。状态机的一个例子可能会采取以下形式: 
  
 在这个状态机的例子中,绿色的步骤指示点工人与客户端交互。任务配置/设置和健康检查可能发生在客户端连接到一个工人。这些步骤可能需要几分钟,所以提前运行它们允许最小延迟当一个客户端连接,通常,我们连接延迟低至几秒。工人可以采取行动来响应客户端请求之前上交的资源使用。例如,如果一个资源是在一个遥远的数据中心,在设备上安装应用程序可能会更快如果本地运行在主机上,而不是在网络上。客户端断开连接之后,工人可以附加额外的元数据的会话以后可以查询。我们使用这个存储日志(例如,设备logcat)和视频会议。通过允许工人异步添加元数据,客户端不需要等待上传完成。 
 工人服务都写在Python 3,这让我们在各种平台上运行它们包括Linux、Mac OS和Windows。一个单独的实例为每个托管资源服务的开始。我们试图隔离这些服务实例从平台上相互支持。在Linux上,例如,这意味着启动每个服务的对照组,配置为只提供其控制的资源。 
 在Android上,我们希望支持现有的全套工具在一个世界中,这意味着正常调用亚行必须工作在我们的系统。否则,每一个工具在Facebook需要修改需要注意的一个世界,这将很快失控。亚行服务器运行一个世界设备主机上,并提供当地的假象亚行实例通过建立TCP通道。例如,我们可以创建一个TCP隧道在端口5037上,标准的亚行港口,和所有流量转发到设备主机的亚行实例。支持亚洲开发银行正向/反向,我们部署一个薄包装亚行二进制,理解这些命令创建隧道和两个啤酒花——第一个设备主机,然后设备本身。 
 虽然th 
 e Android开发环境亚行与Android模拟器或设备进行交互,为开发iOS的工具是Xcode的一部分。寰宇一家远程运行iOS运行时,我们需要一个类似的机制为远程交互的运行时可以用于运行应用程序和不同的测试。 
 在2015年,我们开源FBSimulatorControl,项目控制iOS模拟器。我们已经扩展这个项目,以便与设备,让我们适应的许多我们在Facebook的应用程序。FBSimulatorControl的特性包括: 
 而不是直接对话职工服务,客户而不是连接到一个当地的守护进程来处理谈判和环境设置。在这个协议中,客户机首先创建了一个新的会话的守护进程。会话包含一个规范的运行时客户端需要的类型和数量的并发运行时需要。例如,当运行一个大型测试套件,客户可以要求一个会话20并发Android模拟器。守护进程准备请求的资源保留工人服务实例和执行使用具体到运行时的准备步骤。为Android会话,这意味着设置适当的TCP通道监听localhost和代理交通亚行守护进程在远程机器上。 
 作为客户端需要访问每个预留资源在其会话,它将请求一个守护进程的“租赁”。守护进程的响应方式连接细节或者如果资源还没有通知客户。这些连接细节包括信息,如本地端口用于亚行和FBSimulatorControl。客户用完资源后,释放它通过调用的守护进程。在这一点上,然后守护进程释放所使用的资源完全是一个不同的客户,或保留它在同一个会话如果可能被重用。 
 在整个会话,工人和守护进程通信作为上述状态机模型的一部分。一旦一个工人成为保留通过调度服务,它连接到相应的守护进程服务工作。在会话期间,这个守护进程和工人将执行活性检查,因为他们可能会意外死亡。一旦客户端已经完成会话,守护进程发送一条消息到职工推进“恢复状态”状态机的一部分。 
 而获得管理远程资源允许客户规模,有时候工程师想在本地设备上使用相同的工具来调试问题。我们提供“卫星服务”,允许工程师一个本地资源连接到一个世界云。这意味着你桌子上的电话可以共享与其他工程师和所使用的所有Facebook的自动化通过运行一个简单的命令。像工人服务,卫星服务建立了一系列的SSH隧道从本地机器上一个世界连接到其他基础设施。针对卫星设备而不是管理设备不需要更改代码,和卫星服务设置所需的所有网络路径和出版资源的可用性。 
 上面描述的一个世界守护进程负责连接到服务的重任。我们提供简单的库来处理与守护进程通信的常见模式,使工程师可以很容易地集成到一个世界。下面的代码片段演示了Python API用于运行一个亚行命令在一个世界设备。它开始一个世界守护进程,然后OneWorldADB建立一个会话和街区,直到设备是可用的。Python上下文管理器负责撕裂一切一旦工程师的代码完成。 
 还支持使用多个并发资源。一个世界守护进程管理这些并发资源,通过API,工程师们实现他们自己的系统特定的函数 
 tionality。在下面的示例中,10模拟器是用于运行100个工作岗位,尽快下一个作业将运行一个新的模拟器。最后结果变量将包含100 run_custom_test方法返回的结果。 
 通过CLI临时使用的支持: 
  
 除了提供一个环境临时使用的资源,一个世界支持大量的基础设施项目在Facebook,包括: 
 今天我们有许多重要的应用程序的一个世界,但我们希望我们的未来的工作极大地扩展我们如何使用一个世界在我们的工程工作流程。我们做一些令人兴奋的新功能,包括: 
 你必须登录发表评论。 
 阅读更多… 
 阅读更多… 
 阅读更多… 
  
 Facebook认为在构建社区通过开源技术。探索我们的最新项目人工智能、数据基础设施,开发工具,前端,语言、平台、安全、虚拟现实等。 
  
  
   
  URL : https://code.fb.com/android/managing-resources-for-large-scale-testing/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website
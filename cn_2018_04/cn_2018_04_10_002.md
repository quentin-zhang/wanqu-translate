 
 2018年4月3日 
 | 
  
  
  
  
  
  
 康斯坦丁·hasse还 
  
  
  
  
 | 
  
 支持 
  
 周二,2018年3月13日,travis-ci.com是不工作了约5.5小时从12:14 UTC。有积压的构建另一个3.5小时后,系统返回操作状态。 
 这篇文章概述了发生了什么,并解释为你作为一个travis-ci.com客户”是什么意思。 
 周二,2018年3月13日上午UTC数据库查询是不小心撞上我们的生产数据库所有表截断。查询堵住了大约10分钟,最后在12:14 UTC执行。 
 当我们回应警报之后,我们的API仍然运行约30分钟,几乎与一个空数据库。 
 每当有人在travis-ci.com签署在这段时间里,他们看到空白的用户配置文件。因为他们的老用户从数据库记录已经被抹杀掉了,我们的系统创建新记录,与现有的主键生成序列(PostgreSQL不重置id序列截断)。 
 我们最终将所有应用程序的步骤在我们系统离线,和数据库是几小时后恢复到原来的状态。 
 当我们的在线系统终于回来,那些登录数据库截断的30分钟期间,我们的应用程序离线发现自己错误的用户登录。他们的登录凭证——签署了令牌的形式存储的,对应于用户记录之后创建系统恢复。 
 作为全新的客户并不是唯一的帐户需要新用户记录,因为我们从GitHub定期同步的用户,这意味着新的和现有用户在travis-ci.com上都受到这个问题的影响。 
 为了解决这种情况,所有受影响的令牌被撤销第14章22节UTC周三,3月14日。 
 我们也意识到,一旦数据库恢复,我们不重启cron调度程序,导致错误触发计划cron作业。 
 自中断我们分析应用程序日志的客户帐户可能已经令牌不匹配的影响。我们已经联系了所有的客户在技术上受到了影响。这些没有存储库的子集在travis-ci.com上运行构建,并没有证据表明任何客户数据被暴露。另一个子集构建日志存储库可能暴露,但是我们的访问日志显示没有用户访问构建日志期间的风险。另一个子集有可能暴露,与我们的访问日志显示至少一个用户登录和访问数据期间的风险。 
 我们建议受影响的客户,如果他们已经加密所有秘密(令牌密码,API,敏感环境变量等)使用我们提供加密功能,他们从接触是安全的。我们也建议他们是明智的旋转任何凭证存储在travis-ci.com,即使加密,并检查存储库在travis-ci.com上以确保构建日志不包含其他形式的敏感信息,作为一个预防措施。 
 请检查你的电子邮件从我们安全顾问——主题应该从“特拉维斯CI安全顾问:”开始。我们已经联系了GitHub库管理用户。如果你还没有收到这样的邮件,那么您的帐户没有被影响。请联系support@travis-ci.com与任何问题或问题,我们很乐意协助你可能提出的任何问题。 
 我们已经举行了一次内部事件回顾了解故障发生的数据,可以提高在我们这边来防止这样的失败,以及如何更好的恢复和保护数据如果类似的事件会发生。 
 我们花了一天才发现的根源原始数据库截断。使用我们的API日志,和公司 
 美信从我们的上游供应商的IP地址查询来自,我们能够确定一个截断查询运行测试期间使用数据库更清洁的宝石。壳的测试运行在不知不觉DATABASE_URL环境变量设置为我们的生产数据库。这是一个老终端窗口tmux会话被用于检查许多天前生产数据。开发人员回到这个窗口,执行测试套件DATABASE_URL仍然集。 
 这提出了一个问题,为什么,当需要调试或检查生产数据,连接我们的开发环境到生产数据库以写模式访问。这个问题的答案是,我们的工具和过程很难连接到只读追随者,这就是为什么连接主数据库是一个常见的快捷方式。 
 我们意识到虽然试图理解这个问题,然后迅速应用步骤来解决这个问题,我们inadvertantly面向用户运行的应用程序。这是一个错误,导致创建复制用户id。 
 我们省略了把某些警告了,这意味着我们不知道cron调度程序没有运行。 
 我们提醒最有经验的开发人员可以使无意的错误导致重大故障。 
 积极的一面,我们可以恢复我们整个travis-ci.com生产数据库只有~ 15分钟的数据丢失。 
 我们已经采取措施避免意外截断的数据库表: 
 我们已经采取措施避免加剧问题: 
 除了上面提到的措施外,我们计划短期和长期的改进,旨在让我们的系统更有弹性和防止类似故障的发生。 
 在特拉维斯CI我们非常重视安全。数据失败我们有经验的范围和规模都是空前的。不幸的是,当反应我们错过了一些措施将减少的问题发生。 
 我们非常抱歉给你造成的任何不便业务和开发人员。我们真正价值我们的客户对我们的信任,并期待将很好地利用经验教训继续提高我们的服务。 
 请不要犹豫联系support@travis-ci.com与任何进一步的问题。 
 让我们知道你在想什么,发邮件support@travis-ci.com ! 
 去年11月发行的令牌显示在特拉维斯CI工作日志 
 正确有效的… 
  
 读文章 
  
  
  
  
  
 两周前,16日(周二和周三1月17日,我们有一个主要的故障 
 影响我们的op…… 
  
 读文章 
  
  
  
  
  
 报名参加我们的时事通讯,我们将送你咖啡技巧! 
  
   
  URL : https://blog.travis-ci.com/2018-04-03-incident-post-mortem?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website
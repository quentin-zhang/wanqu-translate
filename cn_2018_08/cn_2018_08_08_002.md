2017年,世界看到爆炸cryptocurrency的流行,以及生态系统的总市值从200亿美元跃升至6000亿美元。Coinbase在这段时间里,几乎每一个组件的技术测试,显示我们的团队,我们需要关注我们的平台的可靠性和可伸缩性,就像我们与安全。自己在MongoDB世界2018年,迈克尔•德这位和约旦Sitkin,所有工程师在Coinbase,谈论了我们的教训,2017年我们如何扩展我们的平台。你可以看下面的谈话或阅读我们回顾。 
 我们的交通模式在2016年,在爆炸发生的前一年cryptocurrency流行,已经非常一致。这次繁荣之前,如果我们有了红线,我们期望我们的平台经验的问题,我们会把它大约四到五次的典型的每日最大流量每分钟约100000后端API请求。 
 然而,2017年5月和6月,醚的价格飙升和交通爆炸过去的红线。有几天在这段时间里,我们经历了持续的交通在这个红色区域,在此期间我们经历了时间的停机时间。 
 解决这些可伸缩性问题快,Coinbase工程团队开始关注长在低处的水果在我们的环境中。我们昼夜不停地工作,执行各种任务,如垂直扩展升级数据库版本利用性能改进,优化索引和分裂出热点收藏到自己的集群。我们每个购买这些改进的空间,但这些唾手可得开始枯竭,和交通仍在继续攀升。 
 在每次停机模式是一样的:我们的主要监控平台将显示100 x延迟激增,连同一个奇怪的50/50分成Ruby和MongoDB。作为我们主要的数据存储,它是有道理的,MongoDB将经历这高延迟期间交通拥挤,但是Ruby时间没有增加。 
 我们亲切地开始把这个问题称为“鬼”,我们现有的监控工具无法提供清晰我们的一些最重要问题的答案。这些查询来自哪里?它们看起来像什么?为什么是一个Ruby中的相关峰值的时间吗?这个问题可能是原始的应用程序? 
 简单地说,我们现有的监视服务无法使用所有可用的上下文里面我们的环境。我们需要一个框架来回答和可视化环境的组件之间的关系。 
 我们开始进一步仪器通过修改MongoDB数据库查询的数据库驱动程序来记录所有查询超过一定的响应时间阈值,以及重要的上下文如请求/响应大小、响应时间、源行代码,查询状态。 
 改进仪表提供我们详细的数据,让我们迅速缩小在出席一些奇怪的特性,即使在non-outage情况。第一次重大异常我们看到是一个非常大的响应大小对象来自设备找到查询。这些大规模的查询将导致大规模的网络负载,当用户将签署在购物或查看仪表板。 
 这极大响应大小的原因是我们之间的关系建模用户和设备类作为一个多对多关系。例如,一些用户可能有多个设备,虽然有些设备可能有多个用户。可怜的设备指纹识别算法有桶数量巨大的用户到相同的设备,导致一个与一系列大规模的user_id设备对象。 
 为了解决这个问题,我们重构这种关系是一对多的关系,在每个设备映射到单个用户。戏剧性的,给Coinbase其性能的影响 
 2017年最大的性能提升。 
 这一发现说明了良好的监测的力量。精确地插装我们的数据库查询之前,这是一个几乎调试问题。新工具,现在是显而易见的。 
 我们着手解决另一个问题是大读吞吐量在某些集合。我们决定添加一个查询缓存层,将在Memcached缓存查询结果。任何单个文档查询特定集合首先查询缓存查询数据库之前,和任何数据库写也会缓存失效。 
 我们可以推出这一变化同时在多个数据库集群。查询缓存写在ORM和驱动程序级别,这允许我们影响多个问题集群。 
 事实证明,大量激增的流量我们经历了在5月和6月相比没有什么增加我们经历了仅仅几个月后,在12月和1月。这些补丁和其他人的帮助下,我们能够承受更大的流量激增。 
 今天我们积极努力确保我们准备下一个cryptocurrency兴趣激增的情况。很容易在这些改进工作时的一个真正的交火中,我们需要找到一种方法来改善我们的未来性能,即使在较低的流量。明显的答案是负载测试环境,模拟交通模式在水平我们过去经历过几次,发现了可能产生下一个弱点。 
 我们选择的解决方案是进行流量捕获和回放,特别是在我们的数据库,生成人工“加密狂热”的需求。对我们来说,这个方法比合成流量产生,因为它消除了要求保持最新合成脚本。我们每次运行套件,我们一定会查询地图交通应用程序产生的类型,基于我们捕获数据。 
 为此,我们建立了一个叫做捕捉工具,叫做mongoreplay包装现有的工具。后选择一个特定的集群在我们的环境中,同时捕获开始磁盘快照并开始捕获原始交通在我们的应用程序服务器上针对集群。然后保存这些捕获的加密版本S3回放在稍后的时间。当我们准备执行回放时,另一个工具叫大炮,基于mongoreplay,回放记录的流量刚启动集群基于前面的集群快照。 
 我们面临的一个挑战是如何捕获的所有MongoDB交通同时单个集群跨多个应用程序服务器。开了10 mb的缓冲炮解决了这个从每个捕获同时合并和过滤捕获。 
 最终结果是一个合并的捕获文件,然后可以有针对性的大炮向刚启动MongoDB集群。大炮允许您选择回放的速度捕获为了模拟加载数千倍我们可能经历的任何一天。 
 我们刚刚开始捕获和大炮,很兴奋地看到的类型发现我们发现我们执行这些类型的负载测试我们所有的MongoDB集群。 
 我们工作的一个主要发现结果与捕获和大炮来自大炮的调试功能。炮有能力检查一个特定的捕获文件,看看第一个100条消息。经检验,我们发现一些有趣的东西: 
 注意到ping命令在发现?证明,MongoDB Ruby驱动程序不正确后,MongoDB司机规范并执行ping命令(检查副本设置状态)与每个查询到数据库。虽然这种行为不太可能已经导致我们的停机时间相关的问题,这是几乎可以肯定“鬼怪”行为的原因我们观察到在我们的监控。 
  
 毕竟努力投入应对这些挑战,我们骄傲的在Coinbase可靠性的当前状态。2017年的事件重申,一个客户访问和查看他们的资金的能力是至关重要的我们实现我们的目标的能力是最可信的地方购买,销售和管理cryptocurrency。安全一直是我们的首要任务,我们兴奋地专注于确保我们的平台是一个首要任务的可靠性! 
 我们已经形成了三个独立的性能和可靠性具体团队准备为未来的一波又一波的cryptocurrency热情。如果你有兴趣在这些类型的挑战,请访问我们的职业页面! 
 除特殊说明外,图像显示来自Coinbase。 
 从一个快速起立鼓掌欢呼,鼓掌能表示你吃得多喜欢这个故事。 
 工程师@Coinbase。 
 了解工作Coinbase:https://www.coinbase.com/careers 
  
   
  URL : https://blog.coinbase.com/how-were-scaling-our-platform-for-spikes-in-customer-demand-4a047cb3139c?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website
在2016年末,我们决定重写我们的老化使用Python和PHP遗留系统的反应。只有四个月在2017年建立一个MVP节日季节,我们必须非常仔细地决定在哪里投资时间。 
 我们投入的技术之一是GraphQL。没有人曾经共事过,但我们认为它快速交付的关键,使人们能够独立工作。 
 这是一个伟大的决定,所以两年后我们要回顾和分享我们学到了什么从那时起… 
 我们决定使用GraphQL深受教训我们的遗留系统。我们使用REST api相当数量的microservices之间创建一个混乱不一致的接口,不同的资源标识符和极其复杂的部署。任何API的变化必须同时部署所有服务使用API来避免停机时间,经常出错,导致发布周期长。在一个API使用GraphQL网关,我们将大大简化服务格局。我们还决定用继电器,给我们一个全球的方式确定资源和组织GraphQL模式的一个简单的方式。 
 我们使用一个服务作为GraphQL服务器,进而使得各种后端请求服务——其中大部分REST api,而是因为他们只与网关通信免费使用他们喜欢的任何东西。网关的设计是完全无状态的,这是伟大的可伸缩性。在GraphQL网关缓存发生,所以很容易扩大我们的整个系统只是扩大网关实例的数量。 
 API网关不规范GraphQL世界,为什么我们使用它们,即使它意味着额外的请求从网关到后端服务吗?对我们来说,最大的原因是减少API相互依赖关系。没有一个网关,看起来大约是这样的:我们的服务结构有许多服务和其他服务,导致大量的API连接增长大约是抛物线与服务的数量。这不仅是不可能保持人的大脑,它还增加了很多复杂性在处理中断、维护和API的变化。 
 GraphQL仍然可以帮助即使在网络这样的向后兼容性,但是这是会发生什么当你把一个简单的网关之间的服务:突然间,只有一个线性的连接数,与每一个新的服务添加一个新的网络连接图。API的变化只需要影响他们的源服务和网关。 
 API网关服务相互通信的唯一方法,大幅降低了复杂性。它还创建了一个伟大的中心位置的缓存,缩放、监视和分析。一般来说,拥有一个单一的服务负责很多事情不是一个好主意——这是一个单点故障。 
 然而,API网关是无状态的。它没有数据库,没有本地资源和身份验证。这意味着它可以横向极易扩展,因为它也负责缓存,就显著增加网关实例的数量可以帮助交通高峰。 
 当然,一个网关并不是免费的:单个请求现在变成了两个,如果一个后台服务想与另一个后台服务,现在必须通过网关。这对创建一个更易于维护中央的界面,但它看起来不伟大的性能。这是一个无状态的网关突然照耀。因为不管网关代码运行时,没有什么阻止我们只有每个后端服务作为自己的网关。相反的两个网络请求,我们GraphQL界面进入每个服务和直接发出请求,不使用GraphQL服务器,同时仍然保持一个中心的优势 
 GraphQL模式。因为我们有GraphQL模式定义在Python中,我们决定更进一步,让这个可用的直接在Python中,通过自动生成一个API包装器的GraphQL模式。 
 结果是,代码服务之间的通信可以现在看起来像这样: 
  
 GraphQL的API包装器模式是完全自动生成的石墨烯的模式,所以服务甚至不需要一个模式文件的副本。没有浪费的请求,验证处理透明的背景和字段是懒洋洋地解决访问。 
 现在,有一些需求做一个好的API公民在这样一个环境。后端api主要能做他们喜欢的任何东西,但是他们必须要和我们如何玩好缓存和权限检查。我们使用的规则在我们的后端api看起来像这样: 
 在REST API返回嵌套对象可以是一个伟大的方式来减少所需的请求数量,但这也使得缓存极其困难,它可能导致overfetching,GraphQL应该战斗。我们通常避免更大、更复杂的请求支持但easier-to-cache和更平滑的请求。 
 有时性能需求大于需要为简单起见,我们将回报,例如,一长串的相关对象嵌套在一个API的回应。然而,我们只能这样做,如果嵌套对象的权限没有更严格的比父对象,因为否则无法缓存的响应。 
 我们使用石墨烯和graphene-django实际运行服务器。我们不使用自动graphene-django Django模型映射的能力,因为所有数据来自外部请求,我们只是用它来兼容我们的堆栈和熟悉。整个网关服务器本质上只是一个GraphQLView,我们稍有扩展允许一些改进我们的前端: 
 GraphQL对我们很好,但我们也犯了很多错误。我们有时会纠结于保持我们的API真正向后兼容和投资额外监控了弃用字段除了性能监控和更好的错误报告。手动更新GraphQL模式与每个API变化可能很乏味,而使它非常容易通过GraphQL之间通信的后端服务我们不小心打破了一些我们自己的服务范围。但最终,它帮助我们发展速度,同时保持我们基础设施的心智模型简单,给我们的团队更多的自治权。 
  
 这篇文章的作者是Rob Kirberich神韵的首席工程师,常驻专家。 
 ©StreetTeam软件有限公司 
 注册在英国登记没有09750608。增值税没有231457819。 
  
   
  URL : https://verve.co/engineering/graphql-a-retrospective/?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website
2018年7月30日 
 Blog-ified版本的讨论我在去西北。 
 写作的内容涵盖了我最近的探索 
 互联网服务,iOS应用程序,和macOS项目 
 独立开发者。 
 这里有几个主题,应该每个人都有自己的博客 
 职位。但是我有很多我要把编程 
 这些笔记是和把材料等一段时间。 
 我的重点是如何适应的课程我学会了工作 
 团队在谷歌一个程序员构建小企业工作。 
 有很多伟大的工程实践在硅谷的大 
 公司和资金充足的风投公司,但一个人没有 
 足够的带宽,编写软件使用它们。 
 运动对我来说是:继续什么,必须去。 
 如果我一直做正确的,描述的技术和技巧 
 这听起来很容易。我必须适应这一切在我的脑海里同时有足够的 
 能力留下写软件的人想要的。 
 每个额外的东西有很大的成本, 
 特别是很少感动回来咬的软件 
 六个月后在半夜。 
 我决定使用两个关键技术去SQLite。 
 SQLite是一个SQL的实现。 
 与传统的PostgreSQL或MySQL数据库实现, 
 SQLite是一个独立的C库设计为嵌入到程序。 
 它已经由d·理查德Hipp自2000年上映以来, 
 在过去的18年其他开源贡献者帮助。 
 在这一点上它已经存在大部分时间我一直编程 
 和是我的一个核心部分的编程工具。 
 而不是讨论SQLite的抽象,让我展示给你。 
 Kaggle有一个善良的人 
 提供了一个CSV文件 
 莎士比亚的戏剧。 
 让我们构建一个SQLite数据库。 
 首先,让我们使用sqlite命令行工具来创建一个新的 
 数据库并导入CSV。 
 完成了!两个选择将很快让我们看看它是否工作。 
 看起来不错! 
 现在我们可以做一些清理工作。 
 最初的CSV包含一列称为AceSceneLine使用点 
 编码数量,数量,和行号。 
 这些看起来更好自己的列。 
 (上面的字符串的子串可以提高使用instr找到”。的字符。 
 练习留给读者)。 
 在这里我们使用了插入……选择语法来构建一个表的另一个表。 
 ActSceneLine列使用装入的SQLite函数是分裂的子串, 
 这片字符串。 
 结果: 
 现在我们有我们的数据,让我们寻找的东西: 
 没有工作。 
 哈姆雷特肯定说,但也许稍微偏离文本格式。 
 SQLite的救援。 
 它附带一个全文搜索扩展编译。 
 让我们索引的所有莎士比亚FTS5: 
 现在我们可以寻找我们的独白: 
 成功!幕和场可以被加入我们的原始表。 
 让我们清理。 
 最后,所有这一切是什么样的文件系统? 
 你拥有它。 
 SQLite数据库包含两个完整的莎士比亚的戏剧的副本, 
 一个全文搜索索引,并将他们存储在约两倍 
 空间需要原来的CSV文件存储。 
 不坏。 
 这应该给你一个感觉的i-t-e SQLite。 
 和场景。 
 有许多cgo-based / sql数据库 
 司机可用于SQLite。 
 似乎是一个最受欢迎 
 github.com/mattn/go-sqlite3。 
 它完成了工作,可能是你想要的。 
 使用数据库/ sql包是直接打开一个SQLite数据库 
 和执行SQL语句。 
 例如,我们可以运行FTS查询从早些时候使用这个代码: 
 执行它的收益率: 
 正如SQLite步骤除了基本的选择、插入、更新、删除 
 全文搜索,其他几个有趣的特性和扩展 
 不能访问的SQL语句。 
 的 
 se需要专门的接口,和许多不支持的接口 
 任何现有的驱动程序。 
 所以我写了我自己的。 
 你可以把它从crawshaw.io / sqlite。 
 特别是,它支持流媒体团接口, 
 会话扩展, 
 并实现了必要sqlite_unlock_notify机械 
 良好的共享类缓存的使用 
 连接池。 
 我将介绍这些特性通过两个使用案例研究: 
 客户端和云。 
 所有这些方法依赖cgo将C集成到走。 
 这是简单的,但增加了一些操作的复杂性。 
 建立一个程序使用SQLite需要一个C编译器为目标。 
 在实践中,这意味着如果你在macOS开发您需要安装 
 linux的交叉编译器。 
 典型的影响软件质量的担忧增加C代码 
 去不适用于SQLite,因为它有一个非凡的程度的测试。 
 异常代码的质量。 
 我建立一个iOS应用程序,几乎所有 
 编写的代码去UI提供的一个web视图。 
 这个程序有一个完整的用户数据的副本,它不是一个薄查看到 
 网络服务器。这意味着存储大量的地方、结构化 
 设备内置数据、全文搜索、后台任务的工作 
 数据库的方式不会破坏UI,和数据库同步变化 
 备份在云端。 
 这是一个很多移动部件为客户。 
 我想写多在JavaScript中,我想写 
 在及时迅速,然后重写如果我曾经设法建立一个 
 Android应用程序。 
 更重要的是,在去服务器,我是一个独立的开发人员。 
 这是绝对至关重要我减少移动块的数量 
 开发环境尽可能最小的号码。 
 因此,努力构建(大比特)的客户端使用的 
 与我的服务器相同的技术。 
 会话扩展可以让你开始一个会话连接一个SQLite。 
 所有更改数据库通过连接打包成 
 patchset blob。 
 扩展应用生成的patchset还提供了方法 
 一个表。 
 这可以用来构建一个非常简单的client-sync系统。 
 定期收集客户的更改,包 
 成一个变更集,上传到服务器应用 
 数据库的备份。 
 如果另一个客户机更改数据库服务器广告 
 客户端,下载一个变更集,适用于它。 
 这需要一点关心的数据库设计。 
 原因我一直FTS表分开的莎士比亚 
 例子是我保持FTS表附加在一个单独的数据库 
 (在SQLite,意味着不同的文件)。 
 云备份数据库从未生成FTS表, 
 客户端是免费的在一个后台线程生成表 
 他们可以落后于数据备份。 
 另一个点的护理是减少冲突。 
 最大的一个是自动增量键。 
 默认情况下rowid表的主键是递增的, 
 这意味着如果你有多个客户端生成rowid吗 
 会看到很多的冲突。 
 我一直在试用两种不同的解决方案。 
 首先是在每个客户端注册一个rowid范围 
 服务器,只有分配自己的距离。 
 它的工作原理。 
 第二个是随机生成int64值,和依赖 
 在碰撞率低。 
 到目前为止,它的工作原理。 
 两种方法都有风险,我还没有决定哪个更好。 
 在实践中,我发现我有一个限制数据库的更新 
 连接保持变更集质量高。 
 (一个变更集没有见其他连接的更改。) 
 为此我保持只读连接池和一个 
 守卫读写连接池的1。 
 只有抓住读写连接的代码需要它的时候, 
 只读和只读连接执行 
 在SQLite连接上。 
 数据库/ sql司机鼓励使用sql事务 
 其Tx typ 
 e,但这似乎并不与嵌套 
 事务。 
 这是一个概念实现保存或发布的SQL,和 
 它是令人惊讶的是可组合代码。 
 如果一个函数需要多个语句在一个事务中, 
 它可以打开一个保存点,然后推迟发布的电话 
 如果函数没有返回错误,或者如果它 
 叫回滚并返回错误。 
 现在,如果这事务函数需要调用另一个事务 
 函数g,g可以使用相同的策略和f可以调用 
 它在一个非常传统的方式: 
 函数g也绝对安全使用的, 
 因为它有自己的事务。 
 我一直用这个保存点+推迟发布或返回一个错误 
 语义现在几个月,发现它非常宝贵的。 
 它便于安全代码封装在SQL事务。 
 上面的例子但是有点笨重,有些边界情况 
 需要处理。 
 (例如,如果释放失败,则需要返回一个错误)。 
 所以我有包裹在一个实用程序: 
 你第一次看到sqliteutil。它可以是一个小保存在行动 
 令人不愉快的,至少对我来说是当我第一次创建它。 
 但我很快就习惯了它,它确实很多繁重。 
 第一次调用sqliteutil。保存在康涅狄格州打开一个保存点 
 并返回一个闭包,要么释放或回滚 
 犯错的价值,集犯错,如果必要的。 
 我花了几个月的时间我现在重新设计服务 
 之前遇到的问题我想和设计服务 
 在未来工作。 
 这个过程使我很多问题的总体设计工作 
 我很喜欢建筑。 
 它可以概括为1 VM,1区,1过程编程。 
 如果你听起来这法子简单地想笑,我认为这是好! 
 它是简单的。 
 它不满足各种各样的需求,我们会像我们的 
 现代华丽的云服务来满足。 
 这不是“serverless”,这意味着当一个服务非常 
 免费小它不运行,当服务不生长 
 自动的规模。 
 事实上,有一个明确的比例限制。 
 现在最好的服务器你可以从亚马逊大致是: 
 这是一个巨大的潜在风险之一的编程过程。 
 然而,我认为是一个宜居的极限。 
 我认为典型的服务没有达到这个比例限制。 
 如果你正在构建一个小型企业,大多数产品能和生长 
 成为年盈利低于这一限制。 
 当你看到极限接近在接下来的两年内, 
 你有一个业务和收入雇佣多个工程师, 
 和新团队可以,面对急剧变化的业务 
 要求,改写服务。 
 达到这个极限是一个很好的问题,因为当它 
 是你将有足够的时间来处理它和人类 
 资源需要解决它。 
 早在小生意你不的生活,每一小时 
 你花努力超出这个比例极限是一个小时 
 ,更好的花和你的客户交谈 
 对他们的需求。 
 这里的工作原理是: 
 不要使用N电脑1什么时候做。 
 进入更多的技术细节, 
 我在AWS上运行一个虚拟机,在一个可用性区域。 
 虚拟机有三个EBS卷(这是亚马逊的名字NAS)。 
 第一个拥有操作系统,日志,临时文件, 
 和任何短暂的SQLite数据库生成 
 主要的数据库,例如FTS表。 
 第二个主要的主要SQLite数据库服务。 
 第三个拥有客户同步SQLite数据库。 
 系统配置为定期系统EBS快照 
 卷和客户EBS卷S3,亚马逊geo-redundant 
 blob存储。这是一个相对便宜的操作可以照本宣科, 
 因为只有块改变复制。 
 主要的EBS卷是定期备份S3非常,定制 
 刷新的代码 
 es细胞膜缓存。我将解释这一点。 
 服务是一个单一的二进制文件上运行这个VM。 
 机器有足够的额外RAM使用linux的磁盘缓存。 
 (第二个副本可以使用服务的旋转起来 
 低停机更换。) 
 的结果,这是一个最多几十小时的服务 
 停机时间一年,差不多苦难阻止损失的变化 
 RAID5阵列物理计算机,和积极的离线备份 
 在每隔几分钟的分布式系统 
 由一个大型团队和维护。 
 这个系统是惊人的简单。 
 我壳到一台机器。 
 这是一个linux机器。 
 我有一个服务的部署脚本,长十行。 
 几乎我所有的性能与pprof工作完成。 
 在一个中等大小的VM时钟5 - 6个并发请求 
 只有几个小时的性能调优。 
 最大的机器上AWS,成千上万。 
 现在谈论更多的细节堆栈: 
 使服务器并发有两个非常重要 
 我使用SQLite特性。 
 第一个是共享缓存,这让我分配一个大 
 池的内存数据库页面缓存和许多并发 
 同时连接可以使用它。 
 这需要一些支持sqlite_unlock_notify司机 
 所以用户代码不需要处理锁事件,但这 
 对最终用户透明代码。 
 第二个是提前写日志。 
 这是一个模式SQLite可以开始时撞到了 
 连接更改磁盘写入事务的方法。 
 而不是锁定数据库,并进行修改 
 回滚日志,附加到一个单独的新变化 
 文件。这允许读者与作者同时工作。 
 细胞膜由SQLite定期刷新,这涉及到 
 锁定数据库和写作的变化。 
 有默认设置。 
 我重写这些和执行WAL冲手动从一个包 
 ,当它完成,也触发了一个S3快照。 
 这个包被称为reallyfsync,如果我可以如何工作 
 正确地测试它我将使它开源。 
 另一个较小的,但重要的特定服务器的功能, 
 SQLite是 
 增量blob API。 
 这允许一个字段在DB读取和写入的字节数 
 没有同时在内存中存储所有字节, 
 每个请求事项时可能被使用 
 几百兆字节,但你希望成千上万的 
 潜在的并发请求。 
 这是其中的一个司机偏离的地方 
 一个更close-to-cgo包装器 
 像: 
 这看起来很像一个文件,甚至可以像使用一个文件, 
 不过有一个前提:斑点的大小被设置时创建的。 
 (因此,我仍然发现临时文件是有用的。) 
 我开始:你真的需要电脑? 
 有些问题确实。 
 例如,你不能建立一个低延迟指数 
 公共互联网只有4 tb的内存。 
 你需要更多。 
 这些问题很有趣, 
 我们喜欢说话很多, 
 但它们相对少量的编写的所有代码。 
 到目前为止所有的项目我idealab的发展 
 适合1计算机。 
 还有更常见的子问题,很难解决 
 有一台电脑。 
 如果你有一个全球的客户基础和需要低延迟 
 你的服务器,光速的方式。 
 但许多与相对可以解决这些问题 
 简单的CDN的产品。 
 另一个伟大的解决方案geo-sharding光速。 
 完全和你的服务在多个独立副本 
 数据中心,将用户的数据移动到附近的服务。 
 这也很容易,有一个小的全球数据库重定向 
 (也许SQLite geo-redundant NFS)将用户重定向 
 特定的DNS名称像.mservice.com {美国东部,美国西}。 
 大多数问题在一台计算机做配合,t 
 哪一个点。 
 花一些时间确定这个点在哪里。 
 如果是年后很有一台电脑就可以了。 
 即使你不写在这个特定的技术堆栈和代码 
 你不是一个独立的开发人员,这里有价值。 
 使用一个大的虚拟机,一个区,一个流程走,SQLite,快照备份堆栈 
 作为一个假设的工具来测试你的设计。 
 所以一个假想的步骤添加到您的设计过程: 
 如果你解决了你的问题在这个堆栈有一个电脑,怎么做 
 远你能得到什么? 
 你有多少客户可以支持吗? 
 什么大小你需要重写你的软件吗? 
 如果这个独立的迷你堆栈将持续业务多年, 
 您可能想要考虑推迟采用现代 
 云软件。 
 如果你是一个程序员在一个资金雄厚的公司,你也可以 
 要考虑对小型内部或发展是什么样子 
 实验项目。 
 你的同事需要使用大型复杂分布式系统 
 政策原因吗? 
 这些项目都不需要规模超出一台电脑, 
 或者如果他们做他们需要重写处理转移 
 要求。 
 在这种情况下,找到一个方法来做一个独立的堆栈,linux vm 
 一个文件系统,可用于原型和实验。 
  
   
  URL : https://crawshaw.io/blog/one-process-programming-notes?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website